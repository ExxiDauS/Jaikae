{% extends 'base.html' %}

{% block title %}
  Jaikae - My Pets
{% endblock %}

{% block content %}
  <div class="container mx-auto px-4 py-8">
    <div class="text-center mb-8">
      <h1 class="text-5xl font-bold text-primary mb-4">üêæ My Pets</h1>
      <p class="text-base-content/70 text-lg">Manage your pets here.</p>
      <a href="{% url 'register_pet' %}" class="btn btn-primary mt-4 text-white">Register New Pet</a>
    </div>
    {% if pets|length == 0 %}
      <div class="text-center text-base-content/70">
        <p class="text-lg">You haven't registered any pets yet.</p>
        <p class="mt-2">
          Ready to help a pet find their forever home? <a href="{% url 'register_pet' %}" class="text-primary underline">Register a pet for adoption</a> today!
        </p>
      </div>
    {% else %}
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        {% for item in pets %}
          <!-- Pet Card -->
          <div class="card card-compact bg-base-100 shadow-md hover:shadow-lg transition-shadow">
            <figure class="relative">
              {% if item.image_url %}
                <img src="{{ item.image_url }}" alt="{{ item.pet.name }}" class="h-48 w-full object-contain" />
              {% else %}
                <div class="flex items-center justify-center h-48 w-full bg-base-200">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <rect x="3" y="5" width="18" height="14" rx="2" stroke-width="2" stroke="currentColor" fill="none" />
                    <circle cx="8" cy="10" r="2" stroke-width="2" stroke="currentColor" fill="none" />
                    <path d="M21 19l-5.5-7-4.5 6-3-4-4 5" stroke-width="2" stroke="currentColor" fill="none" />
                  </svg>
                </div>
              {% endif %}
              <!-- Status Badge -->
              {% if item.pet.status == 'Available' %}
                <div class="badge badge-success absolute bottom-2 left-2">{{ item.pet.status }}</div>
              {% elif item.pet.status == 'Pending' %}
                <div class="badge badge-warning absolute bottom-2 left-2">{{ item.pet.status }}</div>
              {% elif item.pet.status == 'Adopted' %}
                <div class="badge badge-error absolute bottom-2 left-2">{{ item.pet.status }}</div>
              {% else %}
                <div class="badge badge-neutral absolute bottom-2 left-2">{{ item.pet.status }}</div>
              {% endif %}

              {% if item.pet.vaccines.exists %}
                <div class="badge badge-accent absolute top-2 left-2">Vaccinated</div>
              {% endif %}
            </figure>
            <div class="card-body">
              <div class="flex justify-between items-center gap-2">
                <span class="card-title text-primary truncate flex-1 min-w-0">{{ item.pet.name }}</span>
                <div class="badge badge-secondary w-fit font-bold shrink-0">{{ item.pet.age.0 }} years {{ item.pet.age.1 }} months</div>
              </div>
              <div class="text-sm space-y-1">
                <div>
                  {{ item.pet.species }}{% if item.pet.breed %}
                    , {{ item.pet.breed }}
                  {% endif %}
                </div>
                <div>
                  {% if item.pet.gender %}
                    {{ item.pet.gender }}
                  {% else %}
                    Gender not specified
                  {% endif %}
                </div>
                <div>
                  {% if item.pet.color %}
                    {{ item.pet.color }}
                  {% else %}
                    Color not specified
                  {% endif %}
                </div>
                <div>
                  {% if item.pet.weight %}
                    {{ item.pet.weight }} kg
                  {% else %}
                    Weight not specified
                  {% endif %}
                </div>
              </div>
              <p class="text-sm text-base-content/70 mt-2 truncate">
                {% if item.pet.description %}
                  {{ item.pet.description }}
                {% else %}
                  No description available
                {% endif %}
              </p>
              <div class="card-actions justify-between items-center mt-4">
                <div class="text-lg font-bold text-primary">${{ item.pet.adoption_fee }}</div>
                <div class="flex gap-2">
                  <a href="{% url 'pet_detail' item.pet.id %}" class="btn btn-primary btn-sm text-white">Learn More</a>
                  <a href="{% url 'edit_pet' item.pet.id %}" class="btn btn-secondary btn-sm">Edit</a>
                  <button onclick="confirmDelete{{ item.pet.id }}.showModal()" class="btn bg-red-600 text-white btn-sm">Delete</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Delete Confirmation Modal -->
          <dialog id="confirmDelete{{ item.pet.id }}" class="modal">
            <div class="modal-box">
              <h3 class="font-bold text-lg">Confirm Deletion</h3>
              <p class="py-4">
                Are you sure you want to delete <span class="font-semibold text-primary">{{ item.pet.name }}</span>? This action cannot be undone.
              </p>
              <div class="modal-action">
                <form method="dialog">
                  <button class="btn btn-ghost btn-outline">Cancel</button>
                </form>
                <form method="post" action="{% url 'delete_pet' item.pet.id %}" onsubmit="handleDeleteSubmit(event, {{ item.pet.id }})">
                  {% csrf_token %}
                  <button type="submit" class="btn bg-red-600 text-white" id="deleteBtn{{ item.pet.id }}">
                    <span class="delete-text">Delete</span>
                    <span class="loading loading-spinner loading-sm hidden"></span>
                  </button>
                </form>
              </div>
            </div>
            <form method="dialog" class="modal-backdrop">
              <button>close</button>
            </form>
          </dialog>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
      <div class="flex justify-center mt-8">
        <div class="join">
          {# Previous button #}
          {% if page_obj.has_previous %}
            <a href="?{{ filters_querystring }}&page={{ page_obj.previous_page_number }}" class="join-item btn">¬´</a>
          {% else %}
            <span class="join-item btn btn-disabled">¬´</span>
          {% endif %}

          {# Page numbers #}
          {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
              <span class="join-item btn btn-active">{{ num }}</span>
            {% else %}
              <a href="?{{ filters_querystring }}&page={{ num }}" class="join-item btn">{{ num }}</a>
            {% endif %}
          {% endfor %}

          {# Next button #}
          {% if page_obj.has_next %}
            <a href="?{{ filters_querystring }}&page={{ page_obj.next_page_number }}" class="join-item btn">¬ª</a>
          {% else %}
            <span class="join-item btn btn-disabled">¬ª</span>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  <script>
    function handleDeleteSubmit(event, petId) {
      const deleteBtn = document.getElementById(`deleteBtn${petId}`)
      const cancelBtn = document.getElementById(`cancelBtn${petId}`)
      const deleteText = deleteBtn.querySelector('.delete-text')
      const spinner = deleteBtn.querySelector('.loading')
    
      // Disable button and show loading state
      deleteBtn.disabled = true
      cancelBtn.disabled = true
      deleteText.classList.add('hidden')
      spinner.classList.remove('hidden')
    }
  </script>
{% endblock %}
