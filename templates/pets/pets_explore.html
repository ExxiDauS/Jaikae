{% extends 'base.html' %}

{% block title %}
  Jaikae - Pets Explore
{% endblock %}

{% block content %}
  <div class="container mx-auto px-4 py-8">
    <!-- Page Title -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-primary mb-2">Find Your Perfect Companion</h1>
      <p class="text-lg text-base-content/70">Discover amazing pets looking for their forever homes</p>
    </div>

    <div class="flex flex-col lg:flex-row gap-6">
      <!-- Filter Sidebar -->
      <div class="lg:w-1/4">
        <div class="card bg-base-200 shadow-md">
          <div class="card-body">
            <h2 class="card-title text-primary">Filters</h2>

            <form method="get" action="" class="flex flex-col gap-2">
              <!-- Search Name -->
              <div>
                <label class="label"><span class="label-text font-medium">Search by name</span></label>
                <input type="text" name="name" placeholder="Enter pet name..." value="{{ filters.name }}" class="input input-bordered input-sm" />
              </div>

              <!-- Sort by -->
              <div>
                <label class="label"><span class="label-text font-medium">Sort by</span></label>
                <select name="sort_by" class="select select-bordered select-sm">
                  {% if not sort_by or sort_by == 'newest' or sort_by == '' %}
                    <option value="newest" selected>Sort by: Newest</option>
                  {% else %}
                    <option value="newest">Sort by: Newest</option>
                  {% endif %}

                  {% if sort_by == 'oldest' %}
                    <option value="oldest" selected>Sort by: Oldest</option>
                  {% else %}
                    <option value="oldest">Sort by: Oldest</option>
                  {% endif %}

                  {% if sort_by == 'name_az' %}
                    <option value="name_az" selected>Sort by: Name A-Z</option>
                  {% else %}
                    <option value="name_az">Sort by: Name A-Z</option>
                  {% endif %}

                  {% if sort_by == 'name_za' %}
                    <option value="name_za" selected>Sort by: Name Z-A</option>
                  {% else %}
                    <option value="name_za">Sort by: Name Z-A</option>
                  {% endif %}

                  {% if sort_by == 'price_low_high' %}
                    <option value="price_low_high" selected>Sort by: Price Low-High</option>
                  {% else %}
                    <option value="price_low_high">Sort by: Price Low-High</option>
                  {% endif %}

                  {% if sort_by == 'price_high_low' %}
                    <option value="price_high_low" selected>Sort by: Price High-Low</option>
                  {% else %}
                    <option value="price_high_low">Sort by: Price High-Low</option>
                  {% endif %}
                </select>
              </div>

              <!-- Species -->
              <div>
                <label class="label"><span class="label-text font-medium">Species</span></label>
                <select id="species" name="species" class="select select-bordered select-sm" onchange="toggleBreedSelect()">
                  {% if not filters.species %}
                    <option value="" selected>All Species</option>
                  {% else %}
                    <option value="">All Species</option>
                  {% endif %}

                  {% for species in species_options %}
                    {% if filters.species == species %}
                      <option value="{{ species }}" selected>{{ species }}</option>
                    {% else %}
                      <option value="{{ species }}">{{ species }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>

              <!-- Breed -->
              <div>
                <label class="label"><span class="label-text font-medium">Breed</span></label>
                <select id="breed" name="breed" class="select select-bordered select-sm">
                  {% if not filters.breed %}
                    <option value="" selected>All Breeds</option>
                  {% else %}
                    <option value="">All Breeds</option>
                  {% endif %}
                </select>
              </div>

              <!-- Gender -->
              <div>
                <label class="label"><span class="label-text font-medium">Gender</span></label>
                <div class="flex gap-4">
                  {% if not filters.gender or filters.gender == '' %}
                    <label class="label cursor-pointer">
                      <input type="radio" name="gender" value="" class="radio radio-primary radio-sm" checked />
                      <span class="label-text ml-2">Any</span>
                    </label>
                  {% else %}
                    <label class="label cursor-pointer">
                      <input type="radio" name="gender" value="" class="radio radio-primary radio-sm" />
                      <span class="label-text ml-2">Any</span>
                    </label>
                  {% endif %}
                  {% if filters.gender == 'Male' %}
                    <label class="label cursor-pointer">
                      <input type="radio" name="gender" value="Male" class="radio radio-primary radio-sm" checked />
                      <span class="label-text ml-2">Male</span>
                    </label>
                  {% else %}
                    <label class="label cursor-pointer">
                      <input type="radio" name="gender" value="Male" class="radio radio-primary radio-sm" />
                      <span class="label-text ml-2">Male</span>
                    </label>
                  {% endif %}

                  {% if filters.gender == 'Female' %}
                    <label class="label cursor-pointer">
                      <input type="radio" name="gender" value="Female" class="radio radio-primary radio-sm" checked />
                      <span class="label-text ml-2">Female</span>
                    </label>
                  {% else %}
                    <label class="label cursor-pointer">
                      <input type="radio" name="gender" value="Female" class="radio radio-primary radio-sm" />
                      <span class="label-text ml-2">Female</span>
                    </label>
                  {% endif %}
                </div>
              </div>

              <!-- Age Range -->
              <div>
                <label class="label"><span class="label-text font-medium">Age Range (Years)</span></label>
                <div class="grid grid-cols-2 gap-2">
                  {% if filters.min_age %}
                    <input type="number" name="min_age" placeholder="Min" class="input input-bordered input-sm" min="0" value="{{ filters.min_age }}" />
                  {% else %}
                    <input type="number" name="min_age" placeholder="Min" class="input input-bordered input-sm" min="0" />
                  {% endif %}

                  {% if filters.max_age %}
                    <input type="number" name="max_age" placeholder="Max" class="input input-bordered input-sm" min="0" value="{{ filters.max_age }}" />
                  {% else %}
                    <input type="number" name="max_age" placeholder="Max" class="input input-bordered input-sm" min="0" />
                  {% endif %}
                </div>
              </div>

              <!-- Weight Range -->
              <div>
                <label class="label"><span class="label-text font-medium">Weight (kg)</span></label>
                <div class="grid grid-cols-2 gap-2">
                  {% if filters.min_weight %}
                    <input type="number" name="min_weight" placeholder="Min" step="0.1" class="input input-bordered input-sm" min="0" value="{{ filters.min_weight }}" />
                  {% else %}
                    <input type="number" name="min_weight" placeholder="Min" step="0.1" class="input input-bordered input-sm" min="0" />
                  {% endif %}

                  {% if filters.max_weight %}
                    <input type="number" name="max_weight" placeholder="Max" step="0.1" class="input input-bordered input-sm" min="0" value="{{ filters.max_weight }}" />
                  {% else %}
                    <input type="number" name="max_weight" placeholder="Max" step="0.1" class="input input-bordered input-sm" min="0" />
                  {% endif %}
                </div>
              </div>

              <!-- Adoption Fee Range -->
              <div>
                <label class="label"><span class="label-text font-medium">Adoption Fee ($)</span></label>
                <div class="grid grid-cols-2 gap-2">
                  {% if filters.min_fee %}
                    <input type="number" name="min_fee" placeholder="Min" class="input input-bordered input-sm" min="0" value="{{ filters.min_fee }}" />
                  {% else %}
                    <input type="number" name="min_fee" placeholder="Min" class="input input-bordered input-sm" min="0" />
                  {% endif %}

                  {% if filters.max_fee %}
                    <input type="number" name="max_fee" placeholder="Max" class="input input-bordered input-sm" min="0" value="{{ filters.max_fee }}" />
                  {% else %}
                    <input type="number" name="max_fee" placeholder="Max" class="input input-bordered input-sm" min="0" />
                  {% endif %}
                </div>
              </div>

              <!-- Vaccinated -->
              <div>
                <label class="label"><span class="label-text font-medium">Vaccinated</span></label>
                <div class="mt-2">
                  {% if filters.vaccinated %}
                    <label class="label cursor-pointer justify-start">
                      <input type="checkbox" name="vaccinated" value="vaccinated" class="checkbox checkbox-primary checkbox-sm text-white" checked />
                      <span class="label-text ml-3">Vaccinated</span>
                    </label>
                  {% else %}
                    <label class="label cursor-pointer justify-start">
                      <input type="checkbox" name="vaccinated" value="vaccinated" class="checkbox checkbox-primary checkbox-sm text-white" />
                      <span class="label-text ml-3">Vaccinated</span>
                    </label>
                  {% endif %}
                </div>
              </div>

              <!-- Filter Actions -->
              <div class="flex gap-2 mt-2">
                <button type="submit" class="btn btn-primary btn-sm flex-1 text-white">Apply Filters</button>
                <a href="{% url 'pets' %}" class="btn btn-outline btn-sm">Clear</a>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Pet Cards Grid -->
      <div class="lg:w-3/4">
        <!-- Results Info -->
        <div class="flex justify-between items-center mb-6">
          <div class="text-base-content/70">
            <span class="font-medium">{{ pets.count }}</span> pets found.
          </div>
        </div>

        <!-- Pet Cards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
          {% for pet in pets %}
            <!-- Pet Card -->
            <div class="card card-compact bg-base-100 shadow-md hover:shadow-lg transition-shadow">
              <figure class="relative">
                <img src="https://images.unsplash.com/photo-1583337130417-3346a1be7dee?w=400&h=300&fit=crop" alt="Buddy" class="h-48 w-full object-cover" />
                {% if pet.status == "Available" %}
                  <div class="badge badge-success absolute bottom-2 left-2">{{ pet.status }}</div>
                {% elif pet.status == "Pending" %}
                  <div class="badge badge-warning absolute bottom-2 left-2">{{ pet.status }}</div>
                {% elif pet.status == "Adopted" %}
                  <div class="badge badge-error absolute bottom-2 left-2">{{ pet.status }}</div>
                {% else %}
                  <div class="badge badge-neutral absolute bottom-2 left-2">{{ pet.status }}</div>
                {% endif %}
              </figure>
              <div class="card-body">
                <h2 class="card-title text-primary">{{ pet.name }}<div class="badge badge-secondary">{{ pet.age.0 }} years {{ pet.age.1 }} months</div></h2>
                <div class="text-sm space-y-1">
                  <div>
                    {{ pet.species }}{% if pet.breed %}, {{ pet.breed }}{% endif %}
                  </div>
                  <div>{{ pet.gender }}</div>
                  <div>{{ pet.color }}</div>
                  <div>{{ pet.weight }} kg</div>
                </div>
                <p class="text-sm text-base-content/70 mt-2">{% if pet.description %}{{ pet.description }}{% else %}No description available{% endif %}</p>
                <div class="card-actions justify-between items-center mt-4">
                  <div class="text-lg font-bold text-primary">${{ pet.adoption_fee }}</div>
                  <a href="{% url 'pet_detail' pet.id %}" class="btn btn-primary btn-sm text-white">Learn More</a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Pagination -->
        <div class="flex justify-center mt-8">
          <div class="join">
            <button class="join-item btn btn-disabled">«</button>
            <button class="join-item btn btn-active">1</button>
            <button class="join-item btn">2</button>
            <button class="join-item btn">3</button>
            <button class="join-item btn">»</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer footer-center p-10 bg-primary text-primary-content mt-16">
    <div>
      <i class="fas fa-paw text-4xl"></i>
      <p class="font-bold">
        PetAdopt
        <br />Connecting pets with loving families since 2023
      </p>
      <p>Copyright © 2024 - All right reserved</p>
    </div>
  </footer>

  <script>
    const preselectedSpecies = "{{ filters.species|default:'' }}"
    const preselectedBreed = "{{ filters.breed|default:'' }}"
    
    async function toggleBreedSelect() {
      const speciesSelect = document.getElementById('species')
      const breedSelect = document.getElementById('breed')
    
      const species = speciesSelect.value
    
      // reset breed dropdown
      breedSelect.innerHTML = `<option value="">All Breeds</option>`
    
      if (!species) {
        breedSelect.disabled = true
        return
      }
    
      breedSelect.disabled = false
    
      // fetch and populate breed options for selected species
      try {
        const response = await fetch(`/pets/get-breeds/?species=${species}`)
        const data = await response.json()
        console.log(data)
    
        data.breeds.forEach((breed) => {
          const option = document.createElement('option')
          option.value = breed
          option.textContent = breed
    
          // reselect if matches filter
          if (breed === preselectedBreed) {
            option.selected = true
          }
          breedSelect.appendChild(option)
        })
      } catch (error) {
        console.error('Error loading breeds:', error)
      }
    }
    
    // initialize if a species is already selected
    window.addEventListener('DOMContentLoaded', () => {
      const speciesSelect = document.getElementById('species')
      const breedSelect = document.getElementById('breed')
    
      if (!speciesSelect.value) {
        breedSelect.disabled = true
      } else {
        toggleBreedSelect()
      }
    })
  </script>
{% endblock %}
