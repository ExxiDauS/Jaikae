{% extends 'base.html' %}

{% block title %}
  Jaikae - Pets Explore
{% endblock %}

{% block content %}
  <div class="container mx-auto px-4 py-8">
    <!-- Page Title -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-primary mb-2">Find Your Perfect Companion</h1>
      <p class="text-lg text-base-content/70">Discover amazing pets looking for their forever homes</p>
    </div>

    <div class="flex flex-col lg:flex-row gap-6">
      <!-- Filter Sidebar -->
      <div class="lg:w-1/4">
        <div class="card bg-base-200 shadow-md">
          <div class="card-body">
            <h2 class="card-title text-primary">Filters</h2>

            <form method="get" class="flex flex-col gap-2">
              <div>{{ form.name.label_tag }}
                {{ form.name }}</div>

              <div>{{ form.sort_by.label_tag }}
                {{ form.sort_by }}</div>

              <div>{{ form.species.label_tag }}
                {{ form.species }}</div>

              <div>{{ form.breed.label_tag }}
                {{ form.breed }}</div>

              <div>
                <label class="label"><span class="label-text font-medium">Gender</span></label>
                <div class="flex flex-row gap-6">
                  <!-- Any -->
                  {% if not form.data.gender or form.data.gender == '' %}
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="radio" name="gender" value="" class="radio radio-primary radio-sm" checked />
                      <span class="label-text">Any</span>
                    </label>
                  {% else %}
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="radio" name="gender" value="" class="radio radio-primary radio-sm" />
                      <span class="label-text">Any</span>
                    </label>
                  {% endif %}

                  <!-- Male -->
                  {% if form.data.gender == 'Male' %}
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="radio" name="gender" value="Male" class="radio radio-primary radio-sm" checked />
                      <span class="label-text">Male</span>
                    </label>
                  {% else %}
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="radio" name="gender" value="Male" class="radio radio-primary radio-sm" />
                      <span class="label-text">Male</span>
                    </label>
                  {% endif %}

                  <!-- Female -->
                  {% if form.data.gender == 'Female' %}
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="radio" name="gender" value="Female" class="radio radio-primary radio-sm" checked />
                      <span class="label-text">Female</span>
                    </label>
                  {% else %}
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="radio" name="gender" value="Female" class="radio radio-primary radio-sm" />
                      <span class="label-text">Female</span>
                    </label>
                  {% endif %}
                </div>
              </div>

              <div>
                <label class="label"><span class="label-text font-medium">Age Range (Years)</span></label>
                <div class="grid grid-cols-2 gap-2">{{ form.min_age }} {{ form.max_age }}</div>
              </div>

              <div>
                <label class="label"><span class="label-text font-medium">Weight (kg)</span></label>
                <div class="grid grid-cols-2 gap-2">{{ form.min_weight }} {{ form.max_weight }}</div>
              </div>

              <div>
                <label class="label"><span class="label-text font-medium">Adoption Fee ($)</span></label>
                <div class="grid grid-cols-2 gap-2">{{ form.min_fee }} {{ form.max_fee }}</div>
              </div>

              <div>
                {{ form.vaccinated.label_tag }}
                <div class="mt-2 flex gap-2 items-center">
                  {{ form.vaccinated }}
                  <span class="label-text">Vaccinated</span>
                </div>
              </div>

              <div class="flex gap-2 mt-2">
                <button type="submit" class="btn btn-primary btn-sm flex-1 text-white">Apply Filters</button>
                <a href="{% url 'pets' %}" class="btn btn-outline btn-sm">Clear</a>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Pet Cards Grid -->
      <div class="lg:w-3/4">
        <!-- Results Info -->
        <div class="flex justify-between items-center mb-6">
          <div class="text-base-content/70">
            <span class="font-medium">{{ pets|length }}</span> pets found.
          </div>
          <div>
            <a href="{% url 'register_pet' %}" class="btn btn-primary btn-sm text-white">Put your pet up for adoption</a>
          </div>
        </div>

        {% if pets|length == 0 %}
          <div class="text-center text-base-content/70">
            <p class="text-lg">No pets found matching your criteria.</p>
            <p class="mt-2">Try adjusting your filters.</p>
          </div>
        {% else %}
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
          {% for item in pets %}
            <!-- Pet Card -->
            <div class="card card-compact bg-base-100 shadow-md hover:shadow-lg transition-shadow">
              <figure class="relative">
                {% if item.image_url %}
                  <img src="{{ item.image_url }}" alt="{{ item.pet.name }}" class="h-48 w-full object-cover" />
                {% else %}
                  <div class="flex items-center justify-center h-48 w-full bg-base-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <rect x="3" y="5" width="18" height="14" rx="2" stroke-width="2" stroke="currentColor" fill="none" />
                      <circle cx="8" cy="10" r="2" stroke-width="2" stroke="currentColor" fill="none" />
                      <path d="M21 19l-5.5-7-4.5 6-3-4-4 5" stroke-width="2" stroke="currentColor" fill="none" />
                    </svg>
                  </div>
                {% endif %}
                <!-- Status Badge -->
                {% if item.pet.status == 'Available' %}
                  <div class="badge badge-success absolute bottom-2 left-2">{{ item.pet.status }}</div>
                {% elif item.pet.status == 'Pending' %}
                  <div class="badge badge-warning absolute bottom-2 left-2">{{ item.pet.status }}</div>
                {% elif item.pet.status == 'Adopted' %}
                  <div class="badge badge-error absolute bottom-2 left-2">{{ item.pet.status }}</div>
                {% else %}
                  <div class="badge badge-neutral absolute bottom-2 left-2">{{ item.pet.status }}</div>
                {% endif %}

                {% if item.pet.vaccines.exists %}
                  <div class="badge badge-accent absolute top-2 left-2">Vaccinated</div>
                {% endif %}
              </figure>
              <div class="card-body">
                <h2 class="card-title text-primary">{{ item.pet.name }}<div class="badge badge-secondary">{{ item.pet.age.0 }} years {{ item.pet.age.1 }} months</div></h2>
                <div class="text-sm space-y-1">
                  <div>
                    {{ item.pet.species }}{% if item.pet.breed %}
                      , {{ item.pet.breed }}
                    {% endif %}
                  </div>
                  <div>{{ item.pet.gender }}</div>
                  <div>{{ item.pet.color }}</div>
                  <div>{{ item.pet.weight }} kg</div>
                </div>
                <p class="text-sm text-base-content/70 mt-2">
                  {% if item.pet.description %}
                    {{ item.pet.description }}
                  {% else %}
                    No description available
                  {% endif %}
                </p>
                <div class="card-actions justify-between items-center mt-4">
                  <div class="text-lg font-bold text-primary">${{ item.pet.adoption_fee }}</div>
                  <a href="{% url 'pet_detail' item.pet.id %}" class="btn btn-primary btn-sm text-white">Learn More</a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
          <div class="flex justify-center mt-8">
            <div class="join">
              {# Previous button #}
              {% if page_obj.has_previous %}
                <a href="?{{ filters_querystring }}&page={{ page_obj.previous_page_number }}" class="join-item btn">«</a>
              {% else %}
                <span class="join-item btn btn-disabled">«</span>
              {% endif %}

              {# Page numbers #}
              {% for num in page_obj.paginator.page_range %}
                {% if num == page_obj.number %}
                  <span class="join-item btn btn-active">{{ num }}</span>
                {% else %}
                  <a href="?{{ filters_querystring }}&page={{ num }}" class="join-item btn">{{ num }}</a>
                {% endif %}
              {% endfor %}

              {# Next button #}
              {% if page_obj.has_next %}
                <a href="?{{ filters_querystring }}&page={{ page_obj.next_page_number }}" class="join-item btn">»</a>
              {% else %}
                <span class="join-item btn btn-disabled">»</span>
              {% endif %}
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    const preselectedSpecies = "{{ request.GET.species|default:'' }}"
    const preselectedBreed = "{{ request.GET.breed|default:'' }}"
    
    async function toggleBreedSelect() {
      const speciesSelect = document.getElementById('species')
      const breedSelect = document.getElementById('breed')
    
      const species = speciesSelect.value
    
      // reset breed dropdown
      breedSelect.innerHTML = `<option value="">All Breeds</option>`
    
      if (!species) {
        breedSelect.disabled = true
        return
      }
    
      breedSelect.disabled = false
    
      // fetch and populate breed options for selected species
      try {
        const response = await fetch(`/pets/get-breeds/?species=${species}`)
        const data = await response.json()
    
        data.breeds.forEach((breed) => {
          const option = document.createElement('option')
          option.value = breed
          option.textContent = breed
    
          // reselect if matches filter
          if (breed === preselectedBreed) {
            option.selected = true
          }
          breedSelect.appendChild(option)
        })
      } catch (error) {
        console.error('Error loading breeds:', error)
      }
    }
    
    // initialize if a species is already selected
    window.addEventListener('DOMContentLoaded', () => {
      const speciesSelect = document.getElementById('species')
      const breedSelect = document.getElementById('breed')
    
      if (!speciesSelect.value) {
        breedSelect.disabled = true
      } else {
        toggleBreedSelect()
      }
    })
  </script>
{% endblock %}
